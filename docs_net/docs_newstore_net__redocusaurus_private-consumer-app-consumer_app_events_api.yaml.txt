swagger: '2.0'
schemes:
  - https
host: events.highstreetapp-services.com
info:
  version: 0.2.0
  title: Events API
tags:
  - name: Events
  - name: Changelog
    description: >
      ## [Unreleased]

      ### Added

      - Adds the `app_id`, `app_version`, `app_build`, `customer_id`,
      `device_os`,
        `device_os_version` and UTM parameter fields to the request body.
      - Adds the event type `metadata_change`.


      ## [0.2.0] - 2020-05-20

      ### Added

      - Adds the `session_id` field to the request body

      - Adds an `id` field to each event in the request body


      ## [0.1.0] - 2019-04-10

      ### Added

      - Report Events endpoint
consumes:
  - application/json
parameters:
  DebugMode:
    name: debug
    description: Enable debug mode.
    in: query
    type: string
    enum:
      - 'true'
    required: false
  EventsReport:
    name: EventsReport
    description: |
      A list of events to report and identifiers for the merchant and
      customer.
    in: body
    schema:
      $ref: '#/definitions/Report'
    required: true
paths:
  /events:
    post:
      summary: Report Events
      tags:
        - Events
      description: >
        Schedules one or more events for processing.


        When debug mode is enabled the server will not process events. Debug
        mode

        can be used during development or when tracking events is undesirable,

        for example in a test app connecting to the merchant's production

        environment.


        Also see [UTM parameters](https://en.wikipedia.org/wiki/UTM_parameters).
      parameters:
        - $ref: '#/parameters/DebugMode'
        - $ref: '#/parameters/EventsReport'
      responses:
        '202':
          description: Events will be processed
        '422':
          description: The request body is invalid
        '500':
          description: Internal Server Error
definitions:
  Report:
    type: object
    properties:
      merchant_id:
        description: |
          The merchant identifier within Highstreet. This is the same identifier
          used to construct the middleware API URL.
        type: string
      storefront_id:
        description: |
          The identifier of the storefront within Highstreet. This is the same
          identifier used as the `X-Selected-Storefront` header in requests to
          the middleware.
        type: string
      visitor_id:
        description: |
          The customer's visitor ID. A visitor ID can be generated through the
          `POST /visitor_id` endpoint on the middleware.
        type: string
      session_id:
        description: |
          The customer's session ID. A session ID can be generated by the app
          as a UUID. **Since: 0.2.0**.
        type: string
        format: uuid
      app_id:
        description: |
          The bundle ID of the app. **Since: 0.3.0**.
        type: string
      app_version:
        description: |
          The version string of the app reporting events. **Since: 0.3.0**.
        type: string
      app_build:
        description: |
          The version build number of the app reporting events. **Since:
          0.3.0**.
        type: number
      customer_id:
        description: |
          Identifier of the currently logged-in customer as returned by the
          [`GET /account` endpoint](middleware.html#operation/ViewAccount) under
          the `customer_identifiers` object. This should be `null` if the user
          is not logged in or there is no customer identifier. **Since: 0.3.0**.
        type: string
      device_os:
        description: |
          The device OS version. **Since: 0.3.0**.
        type: string
        enum:
          - android
          - ios
      device_os_version:
        description: |
          The version string of the device OS. **Since: 0.3.0**.
        type: string
      utm_campaign:
        description: |
          Value of the `utm_campaign` query string parameter in case the app was
          opened with deeplink. Identifies a specific product promotion or
          strategic campaign. **Since: 0.3.0**.
        type: string
      utm_content:
        description: |
          Value of the `utm_content` query string parameter in case the app was
          opened with deeplink. Identifies what specifically was clicked to
          bring the user to the site, such as a banner ad or a text link. It is
          often used for A/B testing and content-targeted ads. **Since: 0.3.0**.
        type: string
      utm_medium:
        description: |
          Value of the `utm_medium` query string parameter in case the app was
          opened with deeplink. Identifies what type of link was used, such as
          cost per click or email. **Since: 0.3.0**.
        type: string
      utm_source:
        description: |
          Value of the `utm_source` query string parameter in case the app was
          opened with deeplink. Identifies which site sent the traffic, and is a
          required parameter (when using UTM parameters). **Since: 0.3.0**.
        type: string
      utm_term:
        description: |
          Value of the `utm_term` query string parameter in case the app was
          opened with deeplink. Identifies search terms. **Since: 0.3.0**.
        type: string
      events:
        description: A list of events to report.
        type: array
        items:
          $ref: '#/definitions/Event'
        minItems: 1
    required:
      - merchant_id
      - storefront_id
      - events
    example:
      merchant_id: highstreet-production
      storefront_id: en-US
      visitor_id: 9787b226-de31-4808-b4b1-378eaa75af0e
      session_id: 26083842-9a6f-4916-b237-5c6bb345f0a4
      app_id: com.highstreetapp.rosies
      app_version: 1.70.0
      app_build: 202
      customer_id: '44992'
      device_os: android
      device_os_version: '11'
      utm_campaign: spring_sale
      utm_content: textlink
      utm_medium: cpc
      utm_source: Google
      utm_term: running+shoes
      events:
        - id: b479b741-44d0-49ec-b0b8-4641d8f03a1c
          event: product.view
          product_id: 1234_AB-S
        - id: c77ed84d-02f0-4620-b058-2f463767bd7a
          event: category.view
          category_id: women-sale
  Event:
    type: object
    discriminator: event
    properties:
      id:
        description: |
          Unique identifier of the event. Event IDs can be generated by the app
          as a UUID. **Since: 0.2.0**.
        type: string
        format: uuid
      event:
        description: |
          Identifier of the event to track. This affects the accepted payload.
        type: string
    required:
      - event
  product.view:
    allOf:
      - $ref: '#/definitions/Event'
      - properties:
          product_id:
            description: The product ID
            type: string
        required:
          - product_id
          - event
    example:
      id: b479b741-44d0-49ec-b0b8-4641d8f03a1c
      event: product.view
      product_id: 63382_32-M
  category.view:
    allOf:
      - $ref: '#/definitions/Event'
      - properties:
          category_id:
            description: The category ID
            type: string
        required:
          - category_id
        example:
          id: c77ed84d-02f0-4620-b058-2f463767bd7a
          event: category.view
          category_id: sale-women
  metadata_change:
    allOf:
      - $ref: '#/definitions/Event'
    example:
      event: metadata_change